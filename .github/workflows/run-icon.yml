name: ICON2I MeteoD

on:
  schedule:
    # 03:30 UTC tutti i giorni
    - cron: "30 3 * * *"
    # 14:30 UTC tutti i giorni
    - cron: "30 14 * * *"
  workflow_dispatch:

jobs:
  run-bollettino:
    runs-on: ubuntu-latest
    env:
      LC_ALL: it_IT.UTF-8
      LANG: it_IT.UTF-8
      LANGUAGE: it_IT.UTF-8

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: Setup rclone config from secret
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
        run: |
          mkdir -p /home/runner/.config/rclone
          echo "${RCLONE_CONFIG}" > /home/runner/.config/rclone/rclone.conf
          chmod 600 /home/runner/.config/rclone/rclone.conf

      - name: Run ICON2I pipeline and incremental upload
        run: |
          set -e

          # ===============================
          # Determina data e run corretti
          # ===============================
          NOW_HOUR=$(date -u +%H%M)
          if [ "$NOW_HOUR" -lt 0330 ]; then
            DATE=$(date -u -d "yesterday" +%Y%m%d)
            RUN=12
          else
            DATE=$(date -u +%Y%m%d)
            HOUR=$(date -u +%H)
            if [ "$HOUR" -lt 12 ]; then
              RUN=00
            else
              RUN=12
            fi
          fi

          RUN_FOLDER="${DATE}${RUN}"
          LOCAL_DIR="./${RUN_FOLDER}"
          REMOTE_DIR="gd_personal:MeteoD/ICON-2I/${RUN_FOLDER}"

          # ===============================
          # Creazione della cartella remota
          # ===============================
          echo "ðŸ“‚ Creo la cartella remota: $REMOTE_DIR"
          rclone mkdir "$REMOTE_DIR" || true

          # ===============================
          # Funzione di log
          # ===============================
          log_upload() {
            COUNT=$(rclone lsf "$REMOTE_DIR" 2>/dev/null | wc -l || echo 0)
            echo "ðŸ“¥ File caricati finora sul remoto: $COUNT"
          }

          # ===============================
          # Loop di upload in background
          # ===============================
          TOTAL_JSON=160
          (
            while true; do
              # Upload solo se esistono JSON locali
              if [ -d "$LOCAL_DIR" ] && ls "$LOCAL_DIR"/*.json 1> /dev/null 2>&1; then
                echo "â± Upload in corso: $(date -u)"
                rclone copy "$LOCAL_DIR" "$REMOTE_DIR" \
                  --drive-chunk-size 64M \
                  --ignore-existing \
                  --verbose || true
                log_upload

                # Controllo se abbiamo giÃ  tutti i 160 JSON sul remoto
                REMOTE_COUNT=$(rclone lsf "$REMOTE_DIR" 2>/dev/null | wc -l || echo 0)
                if [ "$REMOTE_COUNT" -ge $TOTAL_JSON ]; then
                  echo "âœ… Tutti i $TOTAL_JSON JSON sono stati caricati sul remoto"
                  break
                fi
              fi
              sleep 60
            done
          ) &
          SYNC_PID=$!

          # ===============================
          # Esecuzione pipeline principale
          # ===============================
          python icon2i.py

          # ===============================
          # Attende il completamento dell'upload
          # ===============================
          wait $SYNC_PID 2>/dev/null || true

          echo "ðŸš€ Upload finale completato"
          log_upload
